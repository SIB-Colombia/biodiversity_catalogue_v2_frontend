{"version":3,"sources":["src/auth/index.js"],"names":["http","isAuthenticated","middleware","hasRole","me","signin","signup","logout","getToken","setToken","getUser","setUser","clean","rootMe","type","data","body","FormData","key","append","config","method","headers","mock","component","redirect","rolesRequired","console","log","current","JSON","parse","localStorage","getItem","USER","ok","roles","rolesUser","isAuthorized","forEach","rolReq","RolUser","err","server","local","then","response","json","_id","user","error","message","catch","token","window","location","reload","TOKEN","setItem","Promise","reject","resolve","stringify","clear"],"mappings":"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","file":"index.js","sourceRoot":"/home/leo/htdocs/biodiversity_catalogue_v2_frontend","sourcesContent":["import fetch from 'isomorphic-fetch';\nimport Const from '../const';\nvar rootMe = null;\n\n//Http\nexport function http(type, data) {\n\n  var body = new FormData();\n  if (data)\n    for (var key in data)\n      body.append(key, data[key]);\n\n  data = data\n    ? body\n    : null;\n\n  let config = {\n    method: type,\n    // mode: 'cors',\n    headers: {\n      'Authorization': getToken()\n    },\n    body: data\n  }\n\n  return config;\n\n}\n\n//is authenticated\nexport function isAuthenticated() {\n  return getUser();\n}\n\n//middleware\n\nvar mock = null;\n\nexport function middleware(component, redirect, rolesRequired) {\n\n  console.log('mock', mock);\n\n  let current = mock || JSON.parse(localStorage.getItem(Const.USER));\n\n  if (current) {\n    if (rolesRequired) {\n      let ok = hasRole(rolesRequired, current.roles);\n      if(!ok){\n        return redirect;\n      }else{\n        return component;\n      }\n    }else{\n      return component;\n    }\n\n  } else {\n    console.log('No hay store de usuario, relogin');\n    return redirect;\n    // window.location.href = '';\n  }\n\n}\n\n//has Role\nexport function hasRole(rolesRequired, rolesUser) {\n  try {\n    let isAuthorized = false;\n    rolesRequired.forEach(rolReq => {\n      rolesUser.forEach(RolUser => {\n        if (rolReq === RolUser)\n          isAuthorized = true;\n        }\n      );\n    });\n    return isAuthorized;\n  } catch (err) {\n    return false;\n  }\n}\n\n\n//Me\n\nexport function me() {\n\n  console.log('me');\n\n  return fetch(`${Const.server.local}/api/user/me`, http('GET')).then((response) => {\n    return response.json()\n  }).then((data) => {\n\n    if (data._id) {\n      return setUser(data).then(user => {\n        return user;\n      });\n    } else {\n      throw {error: data.message};\n    }\n\n  }).catch(err => {\n    clean();\n  })\n\n}\n\n//signin\nexport function signin(user) {\n  return fetch(`${Const.server.local}/auth/local`, http('POST', user)).then((response) => {\n    return response.json()\n  }).then((data) => {\n\n    if (data.token) {\n      return setToken(data).then(token => {\n        return token;\n      });\n    } else {\n      throw {error: data.error};\n    }\n  }).catch(err => {\n    return err;\n  })\n}\n\n//signup\nexport function signup(user) {\n  return fetch(`${Const.server.local}/api/user`, http('POST', user)).then((response) => {\n    return response.json()\n  }).then((data) => {\n    return data\n  }).catch(err => {\n    return err;\n  })\n}\n\n//logout\nexport function logout() {\n  clean();\n  window.location.reload();\n}\n\n//Get Token\nexport function getToken() {\n  return localStorage.getItem(Const.TOKEN);\n}\n\n//Set Token\nexport function setToken(data) {\n  try {\n    localStorage.setItem(Const.TOKEN, data.token);\n  } catch (err) {\n    return Promise.reject(err.message);\n  }\n  return Promise.resolve(data.token || null);\n}\n\n//Get User\nexport function getUser() {\n  return JSON.parse(localStorage.getItem(Const.USER));\n}\n\n//Set User\nexport function setUser(data) {\n  try {\n    localStorage.setItem(Const.USER, JSON.stringify(data));\n  } catch (err) {\n    return Promise.reject(err.message);\n  }\n  return Promise.resolve(rootMe = data || null);\n}\n\n//Clean\nexport function clean() {\n  localStorage.clear();\n}\n"]}